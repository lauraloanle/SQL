#link: https://leetcode.com/problems/monthly-transactions-ii/


SELECT LEFT(TRANS_DATE,7) AS MONTH, country, 
SUM(CASE WHEN STATE = 'approved' THEN 1 ELSE 0 END) AS approved_count,
SUM(CASE WHEN STATE = 'approved' THEN AMOUNT ELSE 0 END) AS approved_amount, 
SUM(CASE WHEN STATE = 'BACK' THEN 1 ELSE 0 END) AS chargeback_count,
SUM(CASE WHEN STATE = 'BACK' THEN AMOUNT ELSE 0 END) AS chargeback_amount

FROM

(SELECT TRANS_ID AS ID, COUNTRY, 'BACK' AS STATE, AMOUNT, C.TRANS_DATE
FROM TRANSACTIONS T JOIN CHARGEBACKS C ON T.ID = C.TRANS_ID
UNION ALL
SELECT *
FROM TRANSACTIONS
WHERE STATE = 'approved') TEMP 

GROUP BY MONTH, COUNTRY
ORDER BY MONTH;


